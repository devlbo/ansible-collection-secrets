---
# devlbo.secrets.ssh_keys - Internal constants
#
# These are internal to the role.
# Do NOT override from inventory or playbook vars.
# Prefixed with '__ssh_keys__' (leading double underscore).

# Minimum passphrase length to prevent insecure configurations.
__ssh_keys__min_passphrase_length: 12

# ---------------------------------------------------------------------------
# Normalized path variable (lazy evaluation)
# ---------------------------------------------------------------------------
# Apply normpath to user-supplied paths so that trailing slashes, double
# slashes, and .. segments are resolved consistently.

__ssh_keys__output_dir: >-
  {{ ssh_keys__output_dir | normpath }}

# ---------------------------------------------------------------------------
# Per-user derived variables (lazy evaluation)
# ---------------------------------------------------------------------------
# These resolve per loop iteration because __ssh_keys__item changes with
# each include_tasks call. Lazy evaluation means they re-evaluate on every
# reference, producing the correct value for the current user without any
# set_fact task overhead.
#
# Feature flag: per-user attribute overrides global default.
# Gotcha: These evaluate to strings "True"/"False", not booleans.
# Always pipe through | bool at the point of consumption.

# Resolve if a ssh passphrase is required.
__ssh_keys__do_passphrase: >-
  {{
    __ssh_keys__item.passphrase
    | default(ssh_keys__passphrase)
    | bool
  }}

# Resolve if the raw private key content should be included
# in the output sops file.
__ssh_keys__do_ssh_key_in_sops: >-
  {{
    __ssh_keys__item.ssh_key_in_sops
    | default(ssh_keys__ssh_key_in_sops)
    | bool
  }}

# Per-user confirm_absent override.
# When true, allows deletion of this user's files when state=absent.
__ssh_keys__confirm_absent: >-
  {{
    __ssh_keys__item.confirm_absent
    | default(ssh_keys__confirm_absent)
    | bool
  }}

# ---------------------------------------------------------------------------
# Per-user attribute overrides (lazy evaluation)
# ---------------------------------------------------------------------------

# Per-user sops filename override.
# Default naming pattern: <keyname>.sops.yaml
__ssh_keys__sops_filename: >-
  {{
    (
      __ssh_keys__item.sops_filename
      | default(__ssh_keys__ssh_key_name ~ '.sops.yaml')
    ) | trim
  }}

# Per-user SSH Key name override.
# Default naming pattern: id_<type>_<username>
__ssh_keys__ssh_key_name: >-
  {{
    (
      __ssh_keys__item.ssh_key_name
      | default(
          'id_' ~ ssh_keys__ssh_key_type ~ '_' ~ __ssh_keys__item.username
        )
    ) | trim
  }}

# Per-user SSH Key comment override.
# Default naming pattern: <username>
__ssh_keys__ssh_key_comment: >-
  {{
    (
      __ssh_keys__item.ssh_key_comment
      | default(__ssh_keys__item.username)
    ) | trim
  }}

# Per-user Age keys list override.
# Overrides the global age keys list.
__ssh_keys__age_public_keys: >-
  {{
    __ssh_keys__item.age_public_keys
    | default(ssh_keys__age_public_keys)
  }}

# Per-user SOPS config path override.
# Overrides the global sops_config_path.
__ssh_keys__sops_config_path: >-
  {{
    __ssh_keys__item.sops_config_path
    | default(ssh_keys__sops_config_path)
  }}

# Per-user metadata override.
# Free-form dict, omitted from SOPS output when empty.
__ssh_keys__metadata: >-
  {{ __ssh_keys__item.metadata | default({}) }}

# ---------------------------------------------------------------------------
# Per-user derived paths (lazy evaluation)
# ---------------------------------------------------------------------------
# Composed from lazy components above; re-evaluate per loop iteration.

# SOPS file path computation
__ssh_keys__sops_file_path: >-
  {{
    [__ssh_keys__output_dir, __ssh_keys__sops_filename]
    | ansible.builtin.path_join
  }}

# SSH private key file path computation
__ssh_keys__ssh_private_key_path: >-
  {{
    [__ssh_keys__output_dir, __ssh_keys__ssh_key_name]
    | ansible.builtin.path_join
  }}

# SSH public key file path computation
__ssh_keys__ssh_public_key_path: >-
  {{
    [__ssh_keys__output_dir, __ssh_keys__ssh_key_name ~ '.pub']
    | ansible.builtin.path_join
  }}

# ---------------------------------------------------------------------------
# Aggregate flags (lazy evaluation)
# ---------------------------------------------------------------------------

# True when the role state is 'present' AND at least one user entry has
# state 'present' (explicit or defaulted). Used to skip directory creation
# when no work will be done.
__ssh_keys__has_present_users: >-
  {{
    ssh_keys__state == 'present'
    and (
      ssh_keys__users
      | map(attribute='state', default='present')
      | select('equalto', 'present')
      | list | length > 0
    )
  }}
